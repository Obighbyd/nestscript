!function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var r;Object.defineProperty(e,"__esModule",{value:!0}),e.createVMFromArrayBuffer=e.VirtualMachine=e.operantBytesSize=e.I=void 0;var i,s=n(1);!function(t){t[t.MOV=0]="MOV",t[t.ADD=1]="ADD",t[t.SUB=2]="SUB",t[t.DIV=3]="DIV",t[t.MOD=4]="MOD",t[t.EXP=5]="EXP",t[t.NEG=6]="NEG",t[t.INC=7]="INC",t[t.DEC=8]="DEC",t[t.AND=9]="AND",t[t.OR=10]="OR",t[t.XOR=11]="XOR",t[t.NOT=12]="NOT",t[t.SHL=13]="SHL",t[t.SHR=14]="SHR",t[t.JMP=15]="JMP",t[t.JE=16]="JE",t[t.JNE=17]="JNE",t[t.JG=18]="JG",t[t.JL=19]="JL",t[t.JGE=20]="JGE",t[t.JLE=21]="JLE",t[t.PUSH=22]="PUSH",t[t.POP=23]="POP",t[t.CALL=24]="CALL",t[t.PRINT=25]="PRINT",t[t.RET=26]="RET",t[t.AUSE=27]="AUSE",t[t.EXIT=28]="EXIT",t[t.CALL_CTX=29]="CALL_CTX",t[t.MOV_CTX=30]="MOV_CTX"}(i=e.I||(e.I={})),e.operantBytesSize=((r={})[3]=2,r[4]=2,r[0]=2,r[1]=2,r[5]=2,r[7]=4,r[2]=8,r[6]=0,r);var a=function(){function t(t,e,n,r,i,s){this.codes=t,this.functionsTable=e,this.stringsTable=n,this.entryFunctionIndex=r,this.globalSize=i,this.ctx=s,this.ip=0,this.fp=0,this.sp=-1,this.stack=[];var a=i+1,o=e[r].localSize;this.fp=a,this.stack[this.fp]=-1,this.sp=this.fp+o,this.stack.length=this.sp+1,console.log("globalIndex",a,"localSize",e[r].localSize),console.log("start ---\x3e fp",this.fp,this.sp)}return t.prototype.run=function(){var t=!0,e=this.stack;for(this.ip=this.functionsTable[this.entryFunctionIndex].ip,console.log("start stack",e);t;){var n=this.nextOperator();switch(n){case i.PUSH:var r=this.nextOperant();e[++this.sp]=r.value;break;case i.EXIT:this.stack=e=[],console.log("exit",e),t=!1;break;case i.CALL:var a=this.nextOperant().value,o=this.nextOperant();e[++this.sp]=o.value,e[++this.sp]=this.ip,e[++this.sp]=this.fp,this.ip=a.ip,this.fp=this.sp,this.sp+=a.localSize;break;case i.RET:var c=this.fp;this.fp=e[c],this.ip=e[c-1],this.sp=c-e[c-2]-3,this.stack=e=e.slice(0,this.sp+1);break;case i.PRINT:r=this.nextOperant();console.log(r.value);break;case i.MOV:var u=this.nextOperant(),h=this.nextOperant();this.stack[u.index]=h.value;break;case i.ADD:u=this.nextOperant(),h=this.nextOperant();this.stack[u.index]+=h.value;break;case i.SUB:u=this.nextOperant(),h=this.nextOperant();this.stack[u.index]-=h.value;break;case i.JMP:var p=this.nextOperant();this.ip=p.value;break;case i.JE:this.jumpWithCondidtion((function(t,e){return t===e}));break;case i.JNE:this.jumpWithCondidtion((function(t,e){return t!==e}));break;case i.JG:this.jumpWithCondidtion((function(t,e){return t>e}));break;case i.JL:this.jumpWithCondidtion((function(t,e){return t<e}));break;case i.JGE:this.jumpWithCondidtion((function(t,e){return t>=e}));break;case i.JLE:this.jumpWithCondidtion((function(t,e){return t<=e}));break;case i.CALL_CTX:for(var l=s.getByProp(this.ctx,this.nextOperant().value),f=this.nextOperant().value,d=(o=this.nextOperant().value,[]),b=0;b<o;b++)d.push(e[this.sp--]);e[0]=l[f].apply(l,d),this.stack=e=e.slice(0,this.sp+1);break;case i.MOV_CTX:u=this.nextOperant();var y=this.nextOperant();h=s.getByProp(this.ctx,y.value);this.stack[u.index]=h;break;default:throw new Error("Unknow command "+n)}}},t.prototype.nextOperator=function(){return h(this.codes,this.ip,++this.ip)},t.prototype.nextOperant=function(){var t,e=this.codes,n=h(e,this.ip,++this.ip);switch(n){case 0:case 1:case 5:case 3:case 4:var r=this.ip+2;t=p(e,this.ip,r),this.ip=r;break;case 7:r=this.ip+4;t=l(e,this.ip,r),this.ip=r;break;case 2:r=this.ip+8;t=u(e,this.ip,r),this.ip=r;break;case 6:t=0;break;default:throw new Error("Unknown operant "+n)}return{type:n,value:this.parseValue(n,t),raw:t,index:0===n?this.fp+t:t}},t.prototype.parseValue=function(t,e){switch(t){case 0:return this.stack[this.fp+e];case 5:case 2:case 7:return e;case 1:return this.stack[e];case 4:return this.stringsTable[e];case 3:return this.functionsTable[e];case 6:return this.stack[0];default:throw new Error("Unknown operant "+t)}},t.prototype.jumpWithCondidtion=function(t){var e=this.nextOperant(),n=this.nextOperant(),r=this.nextOperant();t(e.value,n.value)&&(this.ip=r.value)},t}();e.VirtualMachine=a,e.createVMFromArrayBuffer=function(t){var e=l(t,0,4),n=l(t,4,8),r=l(t,8,12),i=l(t,12,16);console.log("main function index",e,"function table basic index",n,"string table basic index",r,"globals szie ",i);var s=c(t.slice(r)),u=t.slice(16,n),h=t.slice(n,r),p=o(h);return console.log("string table",s),console.log("function table",p),console.log(e,p,"function basic index",n),console.log("codes length --\x3e",u.byteLength,r),console.log("main start index",p[e].ip,r),new a(u,p,s,e,i,{name:{age:"TOMY"},console:console})};var o=function(t){for(var e=[],n=0;n<t.byteLength;){var r=n+4,i=l(t,n,r),s=new Uint16Array(t.slice(r,r+4));e.push({ip:i,numArgs:s[0],localSize:s[1]}),n+=8}return e},c=function(t){for(var e=[],n=0;n<t.byteLength;){var r=n+4,i=r+2*l(t,n,r),s=f(t,r,i);e.push(s),n=i}return e},u=function(t,e,n){return new Float64Array(t.slice(e,n))[0]},h=function(t,e,n){return new Uint8Array(t.slice(e,n))[0]},p=function(t,e,n){return new Int16Array(t.slice(e,n))[0]},l=function(t,e,n){return new Uint32Array(t.slice(e,n))[0]},f=function(t,e,n){return s.arrayBufferToString(t.slice(e,n))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getByProp=e.stringToArrayBuffer=e.arrayBufferToString=e.concatBuffer=void 0,e.concatBuffer=function(t,e){var n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n.buffer},e.arrayBufferToString=function(t){return String.fromCharCode.apply(null,Array.from(new Uint16Array(t)))},e.stringToArrayBuffer=function(t){for(var e=t.length,n=new ArrayBuffer(2*e),r=new Uint16Array(n),i=0;i<e;i++)r[i]=t.charCodeAt(i);return n},e.getByProp=function(t,e){return e.split(".").reduce((function(t,e){return t[e]}),t)}}]);